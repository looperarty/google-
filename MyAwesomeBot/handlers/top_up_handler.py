# handlers/top_up_handler.py

from aiogram import Router, F, Bot
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from database import add_balance
from handlers.common_handlers import create_back_keyboard, delete_message_if_exists # <-- Ð˜Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ Ð¸Ð¼Ð¿Ð¾Ñ€Ñ‚

router = Router()

class TopUpState(StatesGroup):
    """Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°."""
    waiting_for_amount = State()

@router.message(F.text == "ðŸ’³ ÐŸÐ¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ")
async def start_top_up(message: Message, state: FSMContext, bot: Bot):
    """ÐÐ°Ñ‡Ð¸Ð½Ð°ÐµÑ‚ Ð¿Ñ€Ð¾Ñ†ÐµÑÑ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð±Ð°Ð»Ð°Ð½ÑÐ°."""
    sent_message = await message.answer(
        "Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ, Ð½Ð° ÐºÐ¾Ñ‚Ð¾Ñ€ÑƒÑŽ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð±Ð°Ð»Ð°Ð½Ñ.",
        reply_markup=await create_back_keyboard() # <-- Ð˜Ð·Ð¼ÐµÐ½Ð¸Ð»Ð¸ Ð²Ñ‹Ð·Ð¾Ð² Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
    )
    await state.update_data(bot_message_id=sent_message.message_id)
    await state.set_state(TopUpState.waiting_for_amount)

@router.message(TopUpState.waiting_for_amount)
async def process_top_up_amount(message: Message, state: FSMContext, bot: Bot):
    """ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ Ð²Ð²ÐµÐ´ÐµÐ½Ð½ÑƒÑŽ ÑÑƒÐ¼Ð¼Ñƒ."""
    state_data = await state.get_data()
    bot_message_id = state_data.get('bot_message_id')
    
    await delete_message_if_exists(bot, message.chat.id, bot_message_id)
    await delete_message_if_exists(bot, message.chat.id, message.message_id)

    try:
        amount = int(message.text)
        if amount <= 0:
            raise ValueError
        
        await add_balance(message.from_user.id, amount)
        await message.answer(f"Ð‘Ð°Ð»Ð°Ð½Ñ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½ Ð½Ð° **{amount}** ÐºÑ€ÐµÐ´Ð¸Ñ‚Ð¾Ð²!")
        await state.clear()
        
    except (ValueError, TypeError):
        await message.answer("ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ðµ Ñ‡Ð¸ÑÐ»Ð¾.")